# Geo Walker

# エレベーターピッチ

知らない街を冒険したいけど、計画が面倒？このアプリなら、ボタンひとつでランダムな目的地を生成し、ルートと予定表を自動生成します。個人旅行者にわくわくする旅と新しい発見を届ける。

---

# 競合アプリとの差別化ポイント

| 項目                            | 内容                                                                                                                           |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| **1. ランダム目的地提案機能**   | Google Maps など従来のナビアプリはユーザー主導の目的地設定が基本だが、本アプリは「未知との遭遇」を重視し、ランダム提案が中心。 |
| **2. 徒歩ルートに特化**         | 観光・冒険向けに徒歩と自転車向け。細かい地形を考慮し、安全性にも配慮。                                                         |
| **3. UI/UX 演出で冒険心を刺激** | 目的地決定時に地図が「ズームイン」していく演出など、遊び心のある演出でワクワク感を演出。                                       |
| **4. 低コスト・個人向け設計**   | lieflet.js、無料の API、postgis などなるべく費用がかからない外部サービスを利用しコストカット                                   |

---

## 利用が想定される外部 API と利用目的

| API 名 / 技術                                              | 利用目的                                                                  | 無料プラン / 備考                                           | 優先度                    |
| ---------------------------------------------------------- | ------------------------------------------------------------------------- | ----------------------------------------------------------- | ------------------------- |
| **OpenCelliD API**                                         | 基地局位置データ → 電波の良し悪しをスポット評価に活用（`is_signal_safe`） | 無料（API キー必要）レート制限あり                          | △（MVP では後回し可）     |
| **Open-Elevation API**または **Mapbox Terrain-RGB**        | 標高取得（坂道/崖/登山ルートを回避）`locations.elevation` に利用          | あり（1 日制限）Mapbox は API キー必須                      | △（将来的に安全性強化に） |
| **Leaflet.js + 地図タイル API**（OSM / Mapbox / Maptiler） | 軽量なマップ表示、ルート線描画、ピン、ズーム演出                          | 無料プランあり（OSM は完全無料）Mapbox は上限あり（50k/月） | ◎（MVP 中核）             |
| **Nominatim (OSM)**                                        | 住所 ↔ 緯度経度変換`locations.local_name` 自動入力に利用                  | 完全無料（ただし大量アクセス制限）商用は Self-host が推奨   | ○                         |
| **OpenWeatherMap API**                                     | 旅当日の天気表示（「傘いる？」UX 向上）                                   | 無料あり（60 calls/min）緯度経度で取得可能                  | △（MVP 後に検討）         |
| **PWA (Service Worker / Manifest)**                        | オフラインキャッシュ、ホーム画面追加、オフライン冒険サポート              | 無料、ブラウザ標準                                          | ○（旅中の切断対策に）     |
| **PostGIS**                                                | 空間検索、危険エリア除外、県境判定、距離計算など全地理処理                | 無料（PostgreSQL 拡張）必須ライブラリ                       | ◎（中核技術）             |

## 追加機能（将来的な差別化拡張）

| 機能                                             | 利用 API 候補                               |
| ------------------------------------------------ | ------------------------------------------- |
| **体力消費シミュレーション**（高低差・距離から） | OpenElevation + Google Fit 連携             |
| **冒険ログ保存・共有**                           | SNS 連携（Twitter API, Instagram API など） |
| **AI による冒険テーマの提案**                    | ChatGPT API or OpenAI Function Calling      |

# 課題

- 必要な言語の学習（Udemy 一周してあとは実践）
- postgis の勉強
- 外部 API を使うためのアカウントの作成
- API の呼び出し順をどうするか
- トランザクション管理をどうするか
- MVP（まずは現在地から〜km 範囲のランダムなピンを指す機能から作る。）
- インフラ構成図の作成
- 使用技術の調査

# 機能要件

| No. | カテゴリ               | 要件内容                                                        |     |
| --- | ---------------------- | --------------------------------------------------------------- | --- |
| F1  | ランダム目的地生成     | 現在地から一定範囲内の地点をランダムに選出する                  |     |
| F2  | 目的地の情報表示       | 選ばれた目的地の名称を表示                                      |     |
| F3  | 徒歩ルート生成         | OSM ベースで徒歩ルートを自動生成し、所要時間と距離を表示        |     |
| F4  | ルートスケジュール作成 | 移動予定時間・到着時間をスケジュール形式で表示                  |     |
| F5  | 地図表示とズーム演出   | Leaflet.js 等で地図を表示し、目的地決定時にズームイン演出を行う |     |
| F6  | 冒険ログ保存           | 目的地・訪問履歴を保存                                          |     |
| F7  | ユーザー認証           | メールまたは OAuth でログインし、ユーザー個別の冒険データを管理 |     |
| F8  | PWA 対応               | モバイル端末にアプリとしてインストール可能な PWA 仕様に対応     |     |

---

# 非機能要件

| No. | カテゴリ               | 要件内容                                                                     |
| --- | ---------------------- | ---------------------------------------------------------------------------- |
| N1  | パフォーマンス         | 目的地提案からルート表示まで、5 秒以内に完了すること                         |
| N2  | 可用性                 | サービス稼働率 99%以上（Supabase などのクラウドサービスを活用）              |
| N3  | セキュリティ           | ユーザーデータは postgress で認証し、Storage と DB に適切な権限管理を行う    |
| N4  | 拡張性                 | 新たな目的地カテゴリや電波データプロバイダーの追加に対応できる構成であること |
| N5  | 保守性                 | API キー・設定値を環境変数で一元管理し、デプロイ・更新が容易であること       |
| N6  | モバイル最適化         | スマートフォンでの表示・操作性を優先設計とする（レスポンシブ対応）           |
| N7  | データ通信最適化       | オフライン用の地図やルートデータは必要最小限のみ事前取得し、通信量を節約する |
| N8  | ライセンス準拠         | 使用する地図・API（OpenStreetMap, OpenCelliD 等）の利用規約を遵守すること    |
| N9  | 多言語対応（できれば） | 国外ユーザー向けに、英語・日本語の 2 言語に対応（初期は日本語のみでも可）    |

# 各テーブルの詳細設計

### 1. `users`（ユーザー）

| カラム名        | 型        | 補足                |
| --------------- | --------- | ------------------- |
| `id`            | UUID      | 主キー（Auth 連携） |
| `email`         | STRING    | メールアドレス      |
| `password_hash` | STRING    | ローカル認証用      |
| `provider`      | STRING    | Google, Apple など  |
| `created_at`    | TIMESTAMP | 登録日時            |

---

### 2. `adventures`（1 回の冒険）

| カラム名                                             | 型        | 説明                                             |
| ---------------------------------------------------- | --------- | ------------------------------------------------ |
| `id`                                                 | UUID      | 冒険 ID                                          |
| `user_id`                                            | UUID      | 外部キー                                         |
| `start_time`                                         | TIMESTAMP | 開始時刻                                         |
| `end_time`                                           | TIMESTAMP | 終了時刻（nullable）                             |
| `status`                                             | STRING    | `planned`, `in_progress`, `completed`, `failed`  |
| `failure_reason`                                     | STRING    | `NOT_ENOUGH_CANDIDATES` などの識別子（nullable） |
| `total_distance`                                     | FLOAT     | 予定されていた距離（例：5.0）                    |
| `created_at`                                         | TIMESTAMP | 作成日時                                         |

---

### 3. `adventure_preferences`（ユーザーが指定した条件）

| カラム名            | 型        | 説明             |
| ------------------- | --------- | ---------------- |
| `id`                | UUID      | 主キー           |
| `adventure_id`      | UUID      | 外部キー（冒険） |
| `total_distance_km` | FLOAT     | ユーザー指定距離 |
| `created_at`        | TIMESTAMP | 作成日時         |

---

### 4. `locations`（各スポット）

| カラム名        | 型      | 説明                                  |
| --------------- | ------- | ------------------------------------- |
| `id`            | UUID    | 主キー                                |
| `local_name`    | TEXT    | 名称（API で取得）                    |
| `latitude`      | FLOAT   | 緯度                                  |
| `longitude`     | FLOAT   | 経度                                  |
| `type`          | TEXT    | `park`, `scenic_spot`, `shrine`, etc. |
| `is_accessible` | BOOLEAN | 立ち入り可能か                        |
| `is_water_area` | BOOLEAN | 水域か                                |

---

### 5. `adventure_locations`（実際に選ばれた地点と順序）

| カラム名         | 型      | 説明                                                        |
| ---------------- | ------- | ----------------------------------------------------------- |
| `id`             | UUID    | 主キー                                                      |
| `adventure_id`   | UUID    | 外部キー                                                    |
| `location_id`    | UUID    | 外部キー                                                    |
| `sequence`       | INTEGER | 何番目の地点か（0=出発地, 1=スポット 1, ...）               |
| `type_used`      | TEXT    | 候補群の中から選ばれた type                                 |
| `selection_type` | TEXT    | `user_selected`, `random_fallback`, `auto_substituted` など |
|  |

---

### 6. `routes`（ルート GeoJSON）

| カラム名         | 型      | 説明                    |
| ---------------- | ------- | ----------------------- |
| `id`             | UUID    | ルート ID               |
| `adventure_id`   | UUID    | 外部キー                |
| `route_json`     | JSONB   | GeoJSON または Polyline |
| `total_distance` | FLOAT   | 実距離（m）             |
| `total_duration` | INTEGER | 時間（分）              |

---

### 7. `risk_zone`（危険地域判別用）

| カラム名     | 型       | 説明     |
| ------------ | -------- | -------- |
| `id`         | UUID     | 主キー   |
| `code`       | UUID     | 外部キー |
| `name`       | STRING   |          |
| `geometry`   | geometry | postgis  |
| `created_at` | DAYTIME  |          |

---

### `preference_spot_type_groups`（スポットタイプのグループ、順序付き）

| カラム名                  | 型        | 説明                                   |
| ------------------------- | --------- | -------------------------------------- |
| `id`                      | UUID      | 主キー                                 |
| `adventure_preference_id` | UUID      | 外部キー（`adventure_preferences.id`） |
| `sequence`                | INTEGER   | グループの順序（0〜）                  |
| `created_at`              | TIMESTAMP | 作成日時                               |

---

### `preference_spot_types`（各グループに属するスポットタイプ候補）

| カラム名                        | 型        | 説明                                         |
| ------------------------------- | --------- | -------------------------------------------- |
| `id`                            | UUID      | 主キー                                       |
| `preference_spot_type_group_id` | UUID      | 外部キー（`preference_spot_type_groups.id`） |
| `spot_type`                     | STRING    | 例: 'park', 'shrine', 'scenic'など           |
| `created_at`                    | TIMESTAMP | 作成日時                                     |

# ER 図

![ER図](./README-image/ER図v12.svg)

# 画面遷移図

---

# MVP

## MVP でやるべきこと（機能要件）

| 項目                                 | 内容                                 | 必須 |
| ------------------------------------ | ------------------------------------ | ---- |
| 現在地の取得                         | GPS で現在地取得                     | ◎    |
| 距離の指定                           | 例：3km / 5km / 10km など            | ◎    |
| ランダムな目的地生成                 | 範囲内で 1 地点抽出                  | ◎    |
| 徒歩ルート生成                       | 現在地 → 目的地                      | ◎    |
| 地図表示                             | Leaflet.js でルート可視化            | ◎    |
| 地点が水域・立入禁止でないことを確認 | PostGIS でフィルタ                   | ○    |
| 旅の履歴保存                         | `adventures`, `routes` 保存          | ○    |
| 冒険スタート演出                     | 地図のズームイン、アニメーションなど | ○    |

---

## ルート生成フロー

1. 現在地取得（GPS or 手入力）
2. 距離選択（例：5km）
3. PostGIS で安全なランダム地点を抽出

   → `ST_DWithin(current_location, locations.geom, radius)`

   → `NOT is_watar_area AND is_accessible = true`

   → `NOT ST_Intersects(risk_zones.geom)`

4. OpenRouteService API などでルート生成
5. 結果を `routes`, `adventures` に保存
6. 地図上に表示（Leaflet + GeoJSON）

---

## UI の流れ（MVP 用）

ルート構成の最終形（MVP レベルでも最低限必要）

```

[現在地] → [スポット1] → [スポット2] → [スポット3] → [目的地]

```

- スポット 1〜3：ユーザーが選んだ種別（例：公園、神社、景観）に従ってランダム抽出
- 目的地：完全にランダム or 条件付きランダム（距離内、安全など）

---

## なぜこれが必要か

| 観点               | 理由                                                      |
| ------------------ | --------------------------------------------------------- |
| ユーザー意図の反映 | 「景観と寺社に立ち寄りたい」という希望を反映              |
| 冒険の文脈         | ランダム生成だけではなく、意味のある経路になる            |
| 距離バランス       | 合計距離（例：5km）に近づけるため、中間スポットで調整     |
| マップ演出         | 各スポットにピン＋ルート → 地図上に冒険ストーリーを描ける |

---

## 必要な処理ステップ（ロジック面）

1. **現在地取得**
2. **ユーザーが距離と種別を指定（例：5km、`[scenic, shrine, park]`）**
3. **PostGIS で各スポットタイプごとに 1 つずつ候補抽出**
   - `ST_DWithin` + `NOT ST_Intersects(risk_zones)`
   - `locations.type IN (...)`
   - 順番は UI で固定
4. **目的地を抽出（ランダム or 条件付き）**
   - 目的地＝終点（例：他のスポットから 1km 圏内の未知の地点）
5. **順番通りに全地点を並べて徒歩ルートを生成（外部 API）**
6. **総距離が超過した場合は再生成 or 距離補正処理**
7. **ルートと各スポットを DB に保存（`adventure_locations`, `routes`など）**

---

## 対応するテーブル構成

| 機能                   | テーブル                                   | 補足                                                        |
| ---------------------- | ------------------------------------------ | ----------------------------------------------------------- |
| 条件（スポット種別順） | `adventure_preferences.ordered_spot_types` | `[['park'], ['shrine'], ['scenic']]` のように順番付きで記録 |
| 選ばれた地点と順番     | `adventure_locations.sequence`             | 0: 現在地, 1: スポット 1, ..., N: 目的地                    |
| 経路                   | `routes.route_json`                        | GeoJSON 形式の一筆書きルート                                |
| 条件失敗（地点不足）   | `adventures.failure_reason`                | `NOT_ENOUGH_CANDIDATES` など                                |

| API 名 / 技術                                              | 利用目的                                                                  | 無料プラン / 備考                                           | 優先度                    |
| ---------------------------------------------------------- | ------------------------------------------------------------------------- | ----------------------------------------------------------- | ------------------------- |
| **OpenCelliD API**                                         | 基地局位置データ → 電波の良し悪しをスポット評価に活用（`is_signal_safe`） | 無料（API キー必要）レート制限あり                          | △（MVP では後回し可）     |
| **Open-Elevation API**または **Mapbox Terrain-RGB**        | 標高取得（坂道/崖/登山ルートを回避）`locations.elevation` に利用          | あり（1 日制限）Mapbox は API キー必須                      | △（将来的に安全性強化に） |
| **Leaflet.js + 地図タイル API**（OSM / Mapbox / Maptiler） | 軽量なマップ表示、ルート線描画、ピン、ズーム演出                          | 無料プランあり（OSM は完全無料）Mapbox は上限あり（50k/月） | ◎（MVP 中核）             |
| **Nominatim (OSM)**                                        | 住所 ↔ 緯度経度変換`locations.local_name` 自動入力に利用                  | 完全無料（ただし大量アクセス制限）商用は Self-host が推奨   | ○                         |
| **OpenWeatherMap API**                                     | 旅当日の天気表示（「傘いる？」UX 向上）                                   | 無料あり（60 calls/min）緯度経度で取得可能                  | △（MVP 後に検討）         |
| **PWA (Service Worker / Manifest)**                        | オフラインキャッシュ、ホーム画面追加、オフライン冒険サポート              | 無料、ブラウザ標準                                          | ○（旅中の切断対策に）     |
| **PostGIS**                                                | 空間検索、危険エリア除外、県境判定、距離計算など全地理処理                | 無料（PostgreSQL 拡張）必須ライブラリ                       | ◎（中核技術）             |
